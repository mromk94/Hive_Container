<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Hive Extension Demo</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root { --gold:#d4af37; --bg:#0a0a0a; --panel:#111; --text:#eee; --muted:#999; --outline:#1b1b1b; }
      body { font-family: system-ui, sans-serif; padding:20px; max-width: 900px; margin: 0 auto; background:radial-gradient(1200px 600px at -20% -30%, rgba(212,175,55,0.07), transparent 60%), var(--bg); color:var(--text); }
      h2 { color: var(--gold); text-shadow: 0 0 18px rgba(212,175,55,.15); }
      button { padding:10px 12px; border-radius:10px; border:1px solid var(--gold); cursor:pointer; background:linear-gradient(180deg, rgba(212,175,55,.18), rgba(212,175,55,.08)); color:var(--text); box-shadow: 0 8px 18px rgba(212,175,55,.12); transition:.15s all ease; }
      button:hover { background: linear-gradient(180deg, rgba(212,175,55,.25), rgba(212,175,55,.12)); transform: translateY(-1px); box-shadow:0 12px 24px rgba(212,175,55,.18); }
      button:active { transform:none; box-shadow:0 6px 12px rgba(212,175,55,.12); }
      pre { white-space: pre-wrap; word-break: break-word; background:var(--panel); color:var(--text); padding:12px; border-radius:10px; border:1px solid var(--outline); box-shadow: inset 0 1px 0 rgba(255,255,255,.03); }
      .row { margin-bottom: 14px; }
      .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
      .label { color: var(--muted); }
      .card { background: linear-gradient(180deg, #141414, #0f0f0f); border:1px solid var(--outline); padding:16px; border-radius:12px; box-shadow: 0 16px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03); }
      .badge { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--gold); color:var(--gold); font-size:12px; margin-right:6px; }
      .loading { display:none; align-items:center; gap:14px; }
      .loading.active { display:flex; }
      .spinner { width:28px; height:28px; border-radius:50%; border:3px solid rgba(212,175,55,.15); border-top-color: var(--gold); animation: spin 1s linear infinite; box-shadow: 0 0 18px rgba(212,175,55,.2); }
      @keyframes spin { to { transform: rotate(360deg); } }
      .steps { font-size:13px; color: var(--muted); }
      details { border:1px solid var(--outline); border-radius:10px; padding:10px; background:#0f0f0f; }
      summary { cursor:pointer; color: var(--gold); }
    </style>
  </head>
  <body>
    <h2>Hive Extension Demo</h2>
    <div class="row">
      <button id="btn-connect">Connect Hive</button>
      <button id="btn-forward" disabled>Forward Example Request</button>
    </div>
    <div class="row"><strong>Status:</strong> <span id="status">Idle</span></div>
    <div id="loading" class="card loading" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <div>
        <div style="font-weight:600;">Working...</div>
        <div class="steps" id="steps">Preparing request</div>
      </div>
    </div>
    <div class="row">
      <strong>Token:</strong>
      <pre id="token">(none)</pre>
    </div>
    <div class="row"><strong>Forward Response:</strong></div>
    <div class="card" id="human-card">
      <div class="label">Who answered</div>
      <div style="margin:6px 0 10px;">
        <span class="badge" id="badge-provider">-</span>
        <span class="badge" id="badge-status">-</span>
        <span class="badge" id="badge-model">-</span>
      </div>
      <div class="label">Answer</div>
      <div id="human" style="margin-top:6px; line-height:1.5;">(none)</div>
    </div>
    <div class="row">
      <details>
        <summary>Show technical details</summary>
        <div class="grid" style="margin-top:8px;">
          <div>
            <div class="label">Summary JSON</div>
            <pre id="response">(none)</pre>
          </div>
          <div>
            <div class="label">usedUrl</div>
            <pre id="usedUrl">(none)</pre>
            <div class="label" style="margin-top:8px;">tried</div>
            <pre id="tried">(none)</pre>
          </div>
        </div>
      </details>
    </div>
    <script>
      const statusEl = document.getElementById('status');
      const tokenEl = document.getElementById('token');
      const respEl = document.getElementById('response');
      const usedUrlEl = document.getElementById('usedUrl');
      const triedEl = document.getElementById('tried');
      const btnConnect = document.getElementById('btn-connect');
      const btnForward = document.getElementById('btn-forward');
      const loading = document.getElementById('loading');
      const steps = document.getElementById('steps');
      const human = document.getElementById('human');
      const badgeProvider = document.getElementById('badge-provider');
      const badgeStatus = document.getElementById('badge-status');
      const badgeModel = document.getElementById('badge-model');

      let sessionToken = null;

      window.addEventListener('message', (evt) => {
        const data = evt.data || {};
        if (data.source === 'HIVE_CONNECT_RELAYED') {
          statusEl.textContent = data.payload && data.payload.ok ? 'Connect relayed to extension' : 'Relay failed';
        }
        if (data.source === 'HIVE_SESSION_APPROVED') {
          sessionToken = data.payload && data.payload.token;
          tokenEl.textContent = JSON.stringify(sessionToken, null, 2);
          statusEl.textContent = 'Session approved';
          btnForward.disabled = !sessionToken;
        }
        if (data.source === 'HIVE_FORWARD_RESPONSE') {
          loading.classList.remove('active');
          const p = data.payload || {};
          respEl.textContent = JSON.stringify(p, null, 2);
          usedUrlEl.textContent = p.usedUrl || '(none)';
          triedEl.textContent = JSON.stringify(p.tried || [], null, 2);
          const ok = !!p.ok;
          statusEl.textContent = ok ? 'Forward success' : 'Forward error';
          renderHuman(p);
          btnForward.disabled = false;
        }
      }, false);

      btnConnect.onclick = () => {
        const originRaw = window.location.origin;
        const appOrigin = originRaw && originRaw !== 'null' ? originRaw : 'file://';
        const sessionRequest = {
          sessionId: 'hive_' + Math.random().toString(36).slice(2,10),
          requestedScopes: ['persona.use'],
          requestedPersona: 'default',
          appOrigin,
          createdAt: Date.now()
        };
        window.postMessage({ source: 'HIVE_CONNECT_REQUEST', payload: sessionRequest }, '*');
      };

      btnForward.onclick = () => {
        if (!sessionToken) { alert('No token yet'); return; }
        const examplePayload = {
          model: 'gpt-4o-mini',
          messages: [ { role: 'user', content: 'Say hello from Hive.' } ]
        };
        btnForward.disabled = true;
        loading.classList.add('active');
        steps.textContent = 'Sending to extension...';
        setTimeout(()=> steps.textContent = 'Selecting provider...', 300);
        setTimeout(()=> steps.textContent = 'Calling the AI model...', 800);
        setTimeout(()=> steps.textContent = 'Awaiting reply...', 1200);
        window.postMessage({ source: 'HIVE_FORWARD_REQUEST', payload: { sessionToken, requestPayload: examplePayload } }, '*');
      };

      function renderHuman(payload) {
        const provider = inferProvider(payload.usedUrl);
        const model = inferModel(payload.response);
        const text = extractText(payload.response);
        human.textContent = text || '(no text)';
        badgeProvider.textContent = provider || '-';
        badgeStatus.textContent = payload.ok ? 'OK' : 'Error';
        badgeStatus.style.borderColor = payload.ok ? 'var(--gold)' : '#e74c3c';
        badgeStatus.style.color = payload.ok ? 'var(--gold)' : '#ff8a8a';
        badgeModel.textContent = model || 'model: unknown';
      }

      function inferProvider(url) {
        if (!url) return 'Unknown';
        if (url.includes('generativelanguage.googleapis.com')) return 'Gemini';
        if (url.includes('api.anthropic.com')) return 'Claude';
        if (url.includes('api.openai.com')) return 'OpenAI';
        return 'Local/Custom';
      }

      function inferModel(resp) {
        try {
          if (!resp) return '';
          if (resp.modelVersion) return resp.modelVersion; // Gemini
          if (resp.model) return resp.model; // Some APIs
          if (resp.choices && resp.choices[0] && resp.choices[0].model) return resp.choices[0].model; // variants
          return '';
        } catch { return ''; }
      }

      function extractText(resp) {
        try {
          if (!resp) return '';
          // Gemini: candidates[0].content.parts[].text
          const c = resp.candidates && resp.candidates[0];
          if (c && c.content && Array.isArray(c.content.parts)) {
            const parts = c.content.parts.map(p=>p && (p.text || '')).filter(Boolean);
            if (parts.length) return parts.join('\n');
          }
          // Claude (messages): content[0].text
          if (Array.isArray(resp.content) && resp.content[0] && resp.content[0].text) return resp.content[0].text;
          // OpenAI: choices[0].message.content
          if (resp.choices && resp.choices[0] && resp.choices[0].message) return resp.choices[0].message.content || '';
          return '';
        } catch { return ''; }
      }
    </script>
  </body>
</html>
